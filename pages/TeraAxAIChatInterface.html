<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TeraAx AI Healthcare Chat | Medical AI Assistant | Professional Healthcare Tools</title>
  <meta name="description" content="TeraAx AI-powered healthcare chat interface for medical professionals. Access BIRP, SOAP documentation tools, patient management, and intelligent medical assistance in one platform." />
  <meta name="keywords" content="healthcare AI, medical chat, BIRP documentation, SOAP notes, patient management, medical assistant, healthcare technology" />
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:title" content="TeraAx AI Healthcare Chat | Medical AI Assistant" />
  <meta property="og:description" content="AI-powered healthcare chat interface for medical professionals with BIRP, SOAP tools, and patient management features." />
<script type="module" src="https://static.rocket.new/rocket-web.js?_cfg=https%3A%2F%2Fneversap7730back.builtwithrocket.new&_be=https%3A%2F%2Fapplication.rocket.new&_v=0.1.8"></script>
</head>
<body>
  <main class="main-container">
    <!-- Animated Background -->
    <div class="background-container">
      <div class="particle particle-1"></div>
      <div class="particle particle-2"></div>
      <div class="particle particle-3"></div>
      <div class="particle particle-4"></div>
      <div class="particle particle-5"></div>
      <div class="particle particle-6"></div>
      <div class="particle particle-7"></div>
      <div class="particle particle-8"></div>
      <div class="particle particle-9"></div>
      <div class="particle particle-10"></div>
    </div>
    
    <!-- Main Content -->
    <div class="content-wrapper">
      <!-- Sidebar -->
      <aside class="sidebar">
        <header class="sidebar-header">
          <div class="logo-section">
            <button class="collapse-btn" aria-label="Toggle sidebar">
              <img src="../assets/images/img_button_collapse.svg" alt="Menu" width="26" height="26" />
            </button>
            <h1 class="logo-text">TeraAx</h1>
          </div>
          
          <div class="new-chat-section">
            <span class="new-chat-text">Nova conversa</span>
            <div class="keyboard-shortcuts">
              <span class="key">Ctrl</span>
              <span class="key">I</span>
            </div>
          </div>
        </header>
        
        <nav class="sidebar-nav">
          <button class="nav-button active">
            <img src="../assets/images/img_svg.svg" alt width="12" height="12" />
            Visitas
          </button>
          <button class="nav-button">
            <img src="../assets/images/img_svg_blue_a700.svg" alt width="12" height="12" />
            Pacientes
          </button>
        </nav>
        
        <div class="sidebar-footer">
          <button class="auth-button primary">Sign up</button>
          <button class="auth-button secondary">Log in</button>
        </div>
      </aside>
      
      <!-- Main Chat Area -->
      <section class="chat-section">
        <div class="chat-container">
          <!-- Chat Messages Area -->
          <div class="chat-messages-container" id="chatMessages">
            <div class="welcome-message">
              <p>Como posso ajudar você hoje?</p>
            </div>
            
            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typingIndicator" style="display: none;">
              <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
              </div>
            </div>
          </div>
          
          <!-- Chat Input Area -->
          <div class="chat-input-container">
            <div class="input-wrapper">
              <div class="input-field">
                <input type="text" placeholder="Ask anything…" class="chat-input" id="chatInput" aria-label="Chat input" autocomplete="off" />
                
                <div class="input-actions">
                  <div class="quick-actions">
                    <button class="quick-action-btn" onclick="addActionToMessage('Pesquisar')">
                      <img src="../assets/images/img_svg_white_a700.svg" alt width="12" height="12" />
                      Pesquisar
                    </button>
                    <button class="quick-action-btn" onclick="addActionToMessage('Legal')">
                      <img src="../assets/images/img_svg_white_a700.svg" alt width="12" height="12" />
                      Legal
                    </button>
                    <button class="quick-action-btn" onclick="addActionToMessage('BIRP')">
                      <img src="../assets/images/img_svg_white_a700.svg" alt width="12" height="12" />
                      BIRP
                    </button>
                    <button class="quick-action-btn" onclick="addActionToMessage('SOAP')">
                      <img src="../assets/images/img_svg_white_a700.svg" alt width="12" height="12" />
                      SOAP
                    </button>
                  </div>
                  
                  <div class="input-controls">
                    <button class="control-btn" aria-label="Choose file">
                      <img src="../assets/images/img_button_choose.svg" alt width="28" height="26" />
                    </button>
                    <button class="control-btn" aria-label="Attach file">
                      <img src="../assets/images/img_button_attach.svg" alt width="36" height="26" />
                    </button>
                    <button class="control-btn voice-btn" aria-label="Voice input" onclick="openPatientModal()" title="Cadastrar e gravar">
                      <img src="../assets/images/img_button_dictation.png" alt width="26" height="26" />
                    </button>
                  </div>
                  
                  <button class="send-button" id="sendButton" onclick="sendMessage()">
                    <img src="../assets/images/img_svg_white_a700.svg" alt width="12" height="12" />
                    <span>Enviar</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Help Button -->
        <button class="help-button" onclick="showHelp()" aria-label="Help">
          <img src="../assets/images/img_button_help_menu.svg" alt="Help" width="44" height="44" />
        </button>
      </section>
    </div>

    <!-- Patient Registration Modal -->
    <div id="patientModal" class="modal-overlay" style="display: none;">
      <div class="modal-container">
        <div class="modal-header">
          <h2 class="modal-title">Paciente não encontrado? Cadastre-o agora</h2>
          <p class="modal-subtitle">Preencha os dados abaixo para vincular a gravação ao paciente corretamente.</p>
          <button class="modal-close-btn" onclick="closePatientModal()" aria-label="Fechar modal">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        
        <form id="patientForm" class="modal-form">
          <div class="form-grid">
            <!-- Nome completo -->
            <div class="form-group">
              <label for="nomeCompleto" class="form-label">Nome completo *</label>
              <input type="text" id="nomeCompleto" name="nomeCompleto" class="form-input" placeholder="Apelido ou nome social (sem abreviações)" required />
              <span class="field-error" id="nomeCompletoError"></span>
            </div>

            <!-- Data de nascimento -->
            <div class="form-group">
              <label for="dataNascimento" class="form-label">Data de nascimento *</label>
              <input type="date" id="dataNascimento" name="dataNascimento" class="form-input" required />
              <span class="field-error" id="dataNascimentoError"></span>
            </div>

            <!-- Idade atual -->
            <div class="form-group">
              <label for="idadeAtual" class="form-label">Idade atual</label>
              <input type="number" id="idadeAtual" name="idadeAtual" class="form-input" placeholder="Calculada automaticamente" readonly />
              <span class="field-help">Apenas para conferência (auto-preenchido)</span>
            </div>

            <!-- Tipo de terapia -->
            <div class="form-group">
              <label for="tipoTerapia" class="form-label">Tipo de terapia *</label>
              <select id="tipoTerapia" name="tipoTerapia" class="form-select" required>
                <option value>Selecione...</option>
                <option value="TO">TO</option>
                <option value="Psico">Psico</option>
                <option value="Fono">Fono</option>
                <option value="Outro">Outro</option>
              </select>
              <span class="field-error" id="tipoTerapiaError"></span>
            </div>

            <!-- Série/ano escolar -->
            <div class="form-group">
              <label for="serieEscolar" class="form-label">Série/ano escolar *</label>
              <select id="serieEscolar" name="serieEscolar" class="form-select" required>
                <option value>Selecione...</option>
                <option value="Pre">Pré</option>
                <option value="1º ano">1º ano</option>
                <option value="2º ano">2º ano</option>
                <option value="3º ano">3º ano</option>
                <option value="4º ano">4º ano</option>
                <option value="5º ano">5º ano</option>
                <option value="6º ano">6º ano</option>
                <option value="7º ano">7º ano</option>
                <option value="8º ano">8º ano</option>
                <option value="9º ano">9º ano</option>
                <option value="Ensino Médio">Ensino Médio</option>
                <option value="Superior">Superior</option>
              </select>
              <span class="field-error" id="serieEscolarError"></span>
            </div>

            <!-- Responsável legal -->
            <div class="form-group">
              <label for="responsavelLegal" class="form-label">Responsável legal *</label>
              <input type="text" id="responsavelLegal" name="responsavelLegal" class="form-input" placeholder="Nome da mãe, pai ou tutor (para LGPD)" required />
              <span class="field-error" id="responsavelLegalError"></span>
            </div>

            <!-- E-mail do responsável -->
            <div class="form-group">
              <label for="emailResponsavel" class="form-label">E-mail do responsável *</label>
              <input type="email" id="emailResponsavel" name="emailResponsavel" class="form-input" placeholder="Enviaremos o laudo para este endereço" required />
              <span class="field-error" id="emailResponsavelError"></span>
            </div>

            <!-- Telefone do responsável -->
            <div class="form-group">
              <label for="telefoneResponsavel" class="form-label">Telefone do responsável *</label>
              <input type="tel" id="telefoneResponsavel" name="telefoneResponsavel" class="form-input" placeholder="WhatsApp para confirmação" required />
              <span class="field-error" id="telefoneResponsavelError"></span>
            </div>

            <!-- Observações rápidas -->
            <div class="form-group full-width">
              <label for="observacoes" class="form-label">Observações rápidas</label>
              <textarea id="observacoes" name="observacoes" class="form-textarea" placeholder="Sinais, medicamentos, alergias (opcional)" rows="3"></textarea>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-secondary" onclick="closePatientModal()">
              Cancelar
            </button>
            <button type="submit" class="btn-primary">
              Cadastrar e gravar
            </button>
          </div>
        </form>

        <div class="modal-footer">
          <p class="privacy-text">
            Seu laudo será enviado por e-mail e poderá ser baixado a qualquer momento. Os dados são usados apenas para vincular a gravação e nunca são compartilhados fora do ambiente clínico.
          </p>
        </div>
      </div>
    </div>

    <!-- Recording Modal -->
    <div id="recordingModal" class="modal-overlay" style="display: none;">
      <div class="modal-container recording-modal">
        <div class="modal-header">
          <h2 class="modal-title">Gravando sessão...</h2>
          <button class="modal-close-btn" onclick="stopRecording()" aria-label="Parar gravação">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="7" y="7" width="6" height="6" fill="currentColor"/>
            </svg>
          </button>
        </div>
        
        <div class="recording-content">
          <div class="recording-visual">
            <div class="microphone-icon" id="microphoneIcon">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C13.1046 2 14 2.89543 14 4V12C14 13.1046 13.1046 14 12 14C10.8954 14 10 13.1046 10 12V4C10 2.89543 10.8954 2 12 2Z" fill="currentColor"/>
                <path d="M19 10V12C19 16.4183 15.4183 20 11 20H9V22H15V24H9V22H7V20H5C5 15.5817 8.58172 12 13 12H19V10Z" fill="currentColor"/>
              </svg>
            </div>
            
            <div class="timer-display" id="timerDisplay">00:00</div>
            
            <div class="recording-info">
              <div class="format-info">Formato: WebM</div>
              <div class="quality-info">Qualidade: HD</div>
            </div>
          </div>
          
          <div class="recording-actions">
            <button type="button" class="btn-primary recording-stop-btn" onclick="stopRecording()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="6" y="6" width="12" height="12" fill="currentColor"/>
              </svg>
              Concluir gravação
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Completed Recording Modal -->
    <div id="completedModal" class="modal-overlay" style="display: none;">
      <div class="modal-container completed-modal">
        <div class="modal-header">
          <h2 class="modal-title">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="success-icon">
              <path d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
            </svg>
            Sessão concluída!
          </h2>
          <button class="modal-close-btn" onclick="closeCompletedModal()" aria-label="Fechar modal">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        
        <div class="completed-content">
          <div class="recording-details">
            <h3>Dados da gravação</h3>
            <div class="detail-item">
              <span class="detail-label">Duração:</span>
              <span class="detail-value" id="finalDuration">00:00:00</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Formato:</span>
              <span class="detail-value">WebM</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Tamanho:</span>
              <span class="detail-value" id="fileSize">~0 MB</span>
            </div>
          </div>
          
          <div class="completed-actions">
            <button type="button" class="btn-secondary" onclick="closeCompletedModal()">
              Cancelar
            </button>
            <button type="button" class="btn-primary" onclick="sendRecording()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 19L7 14L8.41 12.59L11 15.17V4H13V15.17L15.59 12.59L17 14L12 19Z" fill="currentColor"/>
              </svg>
              Enviar agora
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <style>
    /* Reset and base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', 'Helvetica Neue', sans-serif;
      background: linear-gradient(180deg, #030a1b 0%, #09173b 50%, #142f74 100%);
      color: #ffffff;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* Layout components */
    .main-container {
      position: relative;
      width: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .background-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      background-image: url('../assets/images/img_image_3.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }
    
    .content-wrapper {
      position: relative;
      z-index: 1;
      display: flex;
      width: 100%;
      min-height: 100vh;
      padding: 18px;
      gap: 20px;
    }
    
    .sidebar {
      width: 200px;
      background: rgba(20, 25, 33, 0.9);
      border-radius: 18px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      flex-shrink: 0;
    }
    
    .sidebar-header {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .logo-section {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .collapse-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: background-color 0.3s ease;
    }
    
    .collapse-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }
    
    .logo-text {
      font-family: 'Poppins', sans-serif;
      font-size: 20px;
      font-weight: 400;
      line-height: 30px;
      color: #ffffff;
    }
    
    .new-chat-section {
      background: #141921;
      border-radius: 6px;
      padding: 8px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .new-chat-text {
      font-family: 'Poppins', sans-serif;
      font-size: 12px;
      font-weight: 400;
      line-height: 18px;
      color: #ffffff;
    }
    
    .keyboard-shortcuts {
      display: flex;
      gap: 4px;
    }
    
    .key {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      padding: 2px 4px;
      font-family: 'Helvetica Neue', sans-serif;
      font-size: 9px;
      font-weight: 400;
      line-height: 12px;
      color: #ffffff;
    }
    
    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }
    
    .nav-button {
      background: #102046;
      border: none;
      border-radius: 8px;
      padding: 4px 8px 4px 24px;
      display: flex;
      align-items: center;
      gap: 4px;
      font-family: 'Inter', sans-serif;
      font-size: 11px;
      font-weight: 400;
      line-height: 14px;
      color: #ffffff;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .nav-button:hover {
      background: #1a2d5a;
      transform: translateY(-1px);
    }
    
    .nav-button.active {
      background: #2563eb;
    }
    
    .sidebar-footer {
      margin-top: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .auth-button {
      border: none;
      border-radius: 6px;
      padding: 8px 34px;
      font-family: 'Helvetica Neue', sans-serif;
      font-size: 13px;
      font-weight: 500;
      line-height: 17px;
      color: #ffffff;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .auth-button.primary {
      background: linear-gradient(180deg, #043abb 0%, #113ba0 50%, #001d61 100%);
      border: 1px solid transparent;
      background-clip: padding-box;
    }
    
    .auth-button.secondary {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.07) 100%);
    }
    
    .auth-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    
    .chat-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      position: relative;
    }
    
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 60px 56px 68px;
    }
    
    /* Chat Messages Area */
    .chat-messages-container {
      width: 100%;
      max-width: 800px;
      height: 60vh;
      overflow-y: auto;
      margin-bottom: 32px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      padding-right: 8px;
    }
    
    .welcome-message {
      text-align: center;
      color: rgba(255, 255, 255, 0.7);
      font-size: 20px;
      font-weight: 400;
      margin: auto 0;
      max-width: 600px;
    }
    
    .message {
      max-width: 75%;
      padding: 18px 24px;
      border-radius: 20px;
      font-size: 15px;
      line-height: 1.6;
      animation: slideIn 0.4s ease-out;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .message.user {
      align-self: flex-end;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
      border-bottom-right-radius: 6px;
    }
    
    .message.ai {
      align-self: flex-start;
      background: rgba(255, 255, 255, 0.08);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(12px);
      border-bottom-left-radius: 6px;
    }
    
    /* Typing Indicator */
    .typing-indicator {
      align-self: flex-start;
      padding: 18px 24px;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 20px;
      border-bottom-left-radius: 6px;
      backdrop-filter: blur(12px);
      max-width: 100px;
    }
    
    .typing-dots {
      display: flex;
      gap: 6px;
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 50%;
      animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    
    /* Scrollbar for chat messages */
    .chat-messages-container::-webkit-scrollbar {
      width: 8px;
    }
    
    .chat-messages-container::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
    }
    
    .chat-messages-container::-webkit-scrollbar-thumb {
      background: rgba(59, 130, 246, 0.4);
      border-radius: 12px;
    }
    
    .chat-messages-container::-webkit-scrollbar-thumb:hover {
      background: rgba(59, 130, 246, 0.6);
    }
    
    .chat-input-container {
      width: 100%;
      max-width: 800px;
    }
    
    .input-wrapper {
      background: #0e0e0e;
      border: 1px solid rgba(255, 255, 255, 0.16);
      border-radius: 12px;
      padding: 8px 10px;
    }
    
    .input-field {
      display: flex;
      flex-direction: column;
      gap: 40px;
    }
    
    .chat-input {
      background: none;
      border: none;
      outline: none;
      color: #ffffff;
      font-family: 'Helvetica', sans-serif;
      font-size: 13px;
      font-weight: 400;
      line-height: 16px;
      padding: 4px 0;
    }
    
    .chat-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    .input-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }
    
    .quick-actions {
      background: #1c1c1c;
      border-radius: 8px;
      padding: 4px;
      display: flex;
      gap: 4px;
    }
    
    .quick-action-btn {
      background: none;
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 4px;
      padding: 4px;
      display: flex;
      align-items: center;
      gap: 2px;
      font-family: 'Inter', sans-serif;
      font-size: 11px;
      font-weight: 400;
      line-height: 14px;
      color: #ffffff;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .quick-action-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.05);
    }
    
    .input-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .control-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.3s ease;
    }
    
    .control-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.1);
    }
    
    .voice-btn {
      border-radius: 12px;
      overflow: hidden;
    }
    
    .send-button {
      background: linear-gradient(180deg, #043abb 0%, #113ba0 50%, #001d61 100%);
      border: 1px solid rgba(255, 255, 255, 0.12);
      border-radius: 4px;
      padding: 4px;
      display: flex;
      align-items: center;
      gap: 2px;
      font-family: 'Inter', sans-serif;
      font-size: 11px;
      font-weight: 400;
      line-height: 14px;
      color: #ffffff;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .send-button:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(4, 58, 187, 0.4);
    }
    
    .send-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }
    
    .help-button {
      position: fixed;
      bottom: 38px;
      right: 38px;
      width: 44px;
      height: 44px;
      background: linear-gradient(180deg, #0d4de8 0%, #113ba0 50%, #001d61 100%);
      border: 1px solid transparent;
      border-radius: 22px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0px 4px 14px rgba(0, 0, 0, 0.16);
      z-index: 10;
    }
    
    .help-button:hover {
      transform: scale(1.1);
      box-shadow: 0px 8px 24px rgba(13, 77, 232, 0.4);
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.3s ease-out;
    }

    .modal-container {
      background: rgba(20, 25, 33, 0.95);
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      animation: slideUp 0.4s ease-out;
    }

    .modal-header {
      position: relative;
      padding: 24px 24px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .modal-title {
      font-family: 'Poppins', sans-serif;
      font-size: 20px;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 8px;
      line-height: 1.3;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-subtitle {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      line-height: 1.4;
    }

    .modal-close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .modal-close-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
    }

    .modal-form {
      padding: 24px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 32px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-label {
      font-size: 13px;
      font-weight: 500;
      color: #ffffff;
      margin-bottom: 2px;
    }

    .form-input,
    .form-select,
    .form-textarea {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 8px;
      padding: 12px 14px;
      color: #ffffff;
      font-size: 14px;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #2563eb;
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .form-input::placeholder,
    .form-textarea::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }

    .form-input[readonly] {
      background: rgba(255, 255, 255, 0.02);
      border-color: rgba(255, 255, 255, 0.08);
      color: rgba(255, 255, 255, 0.6);
      cursor: not-allowed;
    }

    .form-select {
      cursor: pointer;
    }

    .form-select option {
      background: #1a1f2e;
      color: #ffffff;
    }

    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }

    .field-error {
      font-size: 12px;
      color: #ef4444;
      margin-top: 4px;
      min-height: 16px;
    }

    .field-help {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 2px;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      margin-top: 20px;
    }

    .btn-primary,
    .btn-secondary {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      font-family: 'Inter', sans-serif;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(180deg, #043abb 0%, #113ba0 50%, #001d61 100%);
      color: #ffffff;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(4, 58, 187, 0.4);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #ffffff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-secondary:hover {
      background: rgba(255, 255, 255, 0.15);
      transform: translateY(-1px);
    }

    .modal-footer {
      padding: 20px 24px 24px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .privacy-text {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
      line-height: 1.5;
      text-align: center;
    }

    /* Recording Modal Specific Styles */
    .recording-modal {
      max-width: 450px;
    }

    .recording-content {
      padding: 32px 24px;
      text-align: center;
    }

    .recording-visual {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      margin-bottom: 32px;
    }

    .microphone-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      animation: pulse 2s ease-in-out infinite;
      box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
    }

    @keyframes pulse {
      0% {
        transform: scale(1);
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 0 30px rgba(239, 68, 68, 0.6);
      }
      100% {
        transform: scale(1);
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
      }
    }

    .timer-display {
      font-family: 'Courier New', monospace;
      font-size: 32px;
      font-weight: bold;
      color: #ffffff;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .recording-info {
      display: flex;
      gap: 24px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.8);
    }

    .recording-actions {
      display: flex;
      justify-content: center;
    }

    .recording-stop-btn {
      padding: 16px 32px;
      font-size: 16px;
      border-radius: 12px;
    }

    .recording-stop-btn:hover {
      background: linear-gradient(180deg, #dc2626 0%, #b91c1c 50%, #7f1d1d 100%);
    }

    /* Completed Modal Specific Styles */
    .completed-modal {
      max-width: 500px;
    }

    .completed-content {
      padding: 24px;
    }

    .success-icon {
      flex-shrink: 0;
    }

    .recording-details {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .recording-details h3 {
      font-size: 16px;
      font-weight: 600;
      color: #ffffff;
      margin-bottom: 16px;
      text-align: center;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .detail-item:last-child {
      border-bottom: none;
    }

    .detail-label {
      font-weight: 500;
      color: rgba(255, 255, 255, 0.8);
    }

    .detail-value {
      font-weight: 600;
      color: #ffffff;
      font-family: 'Courier New', monospace;
    }

    .completed-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }
    
    /* Animated particles */
    .particle {
      position: absolute;
      width: 8px;
      height: 8px;
      background: linear-gradient(180deg, #ffffff 0%, rgba(255, 93, 93, 0) 100%);
      border-radius: 4px;
      opacity: 0.8;
      animation: float 6s ease-in-out infinite;
    }
    
    .particle-1 { top: 20%; left: 10%; animation-delay: 0s; }
    .particle-2 { top: 40%; left: 80%; animation-delay: 1s; }
    .particle-3 { top: 60%; left: 30%; animation-delay: 2s; }
    .particle-4 { top: 80%; left: 70%; animation-delay: 3s; }
    .particle-5 { top: 30%; left: 50%; animation-delay: 4s; }
    .particle-6 { top: 70%; left: 20%; animation-delay: 5s; }
    .particle-7 { top: 10%; left: 60%; animation-delay: 1.5s; }
    .particle-8 { top: 50%; left: 90%; animation-delay: 2.5s; }
    .particle-9 { top: 90%; left: 40%; animation-delay: 3.5s; }
    .particle-10 { top: 25%; left: 75%; animation-delay: 4.5s; }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.8; }
      50% { transform: translateY(-20px) rotate(180deg); opacity: 1; }
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(24px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes typing {
      0%, 80%, 100% {
        transform: scale(0);
      }
      40% {
        transform: scale(1);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(40px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    /* Responsive media queries */
    @media (max-width: 639px) {
      .content-wrapper {
        flex-direction: column;
        padding: 12px;
        gap: 12px;
      }
      
      .sidebar {
        width: 100%;
        order: 2;
        padding: 12px;
      }
      
      .logo-section {
        justify-content: center;
      }
      
      .new-chat-section {
        flex-direction: column;
        gap: 8px;
      }
      
      .sidebar-footer {
        flex-direction: row;
        gap: 8px;
      }
      
      .auth-button {
        flex: 1;
        padding: 8px 16px;
        font-size: 12px;
      }
      
      .chat-container {
        padding: 40px 16px 32px;
      }
      
      .chat-messages-container {
        height: 50vh;
      }
      
      .input-actions {
        flex-direction: column;
        gap: 12px;
      }
      
      .quick-actions {
        width: 100%;
        justify-content: space-between;
      }
      
      .input-controls {
        justify-content: center;
      }
      
      .help-button {
        bottom: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
      }
      
      .message {
        max-width: 85%;
      }

      .modal-overlay {
        padding: 10px;
      }

      .modal-container {
        max-height: 95vh;
      }

      .form-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .modal-actions,
      .completed-actions {
        flex-direction: column-reverse;
      }

      .btn-primary,
      .btn-secondary {
        width: 100%;
        justify-content: center;
      }

      .recording-info {
        flex-direction: column;
        gap: 8px;
      }

      .timer-display {
        font-size: 28px;
      }

      .recording-stop-btn {
        padding: 14px 28px;
        font-size: 15px;
      }
    }
    
    @media (min-width: 640px) {
      .content-wrapper {
        padding: 16px;
      }
      
      .sidebar {
        width: 220px;
      }
      
      .chat-container {
        padding: 0 32px 48px;
      }
    }
    
    @media (min-width: 768px) {
      .content-wrapper {
        padding: 18px;
      }
      
      .sidebar {
        width: 240px;
      }
      
      .logo-text {
        font-size: 22px;
      }
      
      .new-chat-text {
        font-size: 13px;
      }
      
      .nav-button {
        font-size: 12px;
        padding: 6px 12px 6px 28px;
      }
      
      .auth-button {
        font-size: 14px;
      }
      
      .chat-input {
        font-size: 14px;
      }
      
      .quick-action-btn {
        font-size: 12px;
        padding: 6px 8px;
      }
    }
    
    @media (min-width: 1024px) {
      .sidebar {
        width: 260px;
      }
      
      .chat-container {
        padding: 0 56px 68px;
      }
      
      .input-field {
        gap: 40px;
      }
    }
    
    @media (min-width: 1280px) {
      .content-wrapper {
        max-width: 1400px;
        margin: 0 auto;
      }
    }
    
    /* Interactive states */
    button:focus {
      outline: 2px solid #2563eb;
      outline-offset: 2px;
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    .chat-input:focus {
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.5);
    }
    
    /* Accessibility */
    @media (prefers-reduced-motion: reduce) {
      .particle {
        animation: none;
      }
      
      .microphone-icon {
        animation: none;
      }
      
      * {
        transition: none !important;
      }
    }
  </style>
  
  <script>
    // Global variables
    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');
    const typingIndicator = document.getElementById('typingIndicator');
    const sidebar = document.querySelector('.sidebar');
    const patientModal = document.getElementById('patientModal');
    const recordingModal = document.getElementById('recordingModal');
    const completedModal = document.getElementById('completedModal');
    const patientForm = document.getElementById('patientForm');
    const timerDisplay = document.getElementById('timerDisplay');
    
    let isRecording = false;
    let mediaRecorder = null;
    let recordedChunks = [];
    let recordingTimer = null;
    let recordingStartTime = null;
    let patientData = null;
    
    // Sidebar toggle functionality
    document.querySelector('.collapse-btn').addEventListener('click', function() {
      sidebar.classList.toggle('collapsed');
    });
    
    // Navigation button interactions
    document.querySelectorAll('.nav-button').forEach(button => {
      button.addEventListener('click', function() {
        document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
      });
    });
    
    // Chat input functionality
    chatInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    sendButton.addEventListener('click', sendMessage);
    
    // Main send message function with n8n webhook integration
    async function sendMessage() {
      const message = chatInput.value.trim();
      if (!message) return;
      
      // Add user message to chat
      addMessage(message, 'user');
      chatInput.value = '';
      
      // Disable send button and show loading state
      sendButton.disabled = true;
      sendButton.innerHTML = '<img src="../assets/images/img_svg_white_a700.svg" alt width="12" height="12" /><span>Enviando...</span>';
      showTyping();
      
      try {
        // Send request to n8n webhook
        const response = await fetch('https://atendimento1n8n-n8n.nid263.easypanel.host/webhook/f9f9b0ad-0d52-4358-8242-4378017a3805', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: message,
            timestamp: new Date().toISOString()
          })
        });
        
        if (response.ok) {
          const result = await response.text();
          addMessage(result, 'ai');
        } else {
          addMessage('Desculpe, ocorreu um erro. Tente novamente.', 'ai');
        }
      } catch (error) {
        console.error('Erro:', error);
        addMessage('Erro de conexão. Verifique sua internet e tente novamente.', 'ai');
      } finally {
        hideTyping();
        sendButton.disabled = false;
        sendButton.innerHTML = '<img src="../assets/images/img_svg_white_a700.svg" alt width="12" height="12" /><span>Enviar</span>';
      }
    }
    
    // Function to add messages to the chat
    function addMessage(text, sender) {
      const messageDiv = document.createElement('div');
      messageDiv.classList.add('message', sender);
      messageDiv.textContent = text;
      
      // Remove welcome message if it exists
      const welcomeMessage = document.querySelector('.welcome-message');
      if (welcomeMessage) {
        welcomeMessage.remove();
      }
      
      chatMessages.appendChild(messageDiv);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Function to add action to message
    function addActionToMessage(action) {
      const currentMessage = chatInput.value.trim();
      const actionText = currentMessage ? 
        currentMessage + ' [' + action + ']' : 
        action + ': ';
      chatInput.value = actionText;
      chatInput.focus();
    }

    // Patient Modal Functions
    function openPatientModal() {
      patientModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      // Focus on first input
      setTimeout(() => {
        document.getElementById('nomeCompleto').focus();
      }, 100);
    }

    function closePatientModal() {
      patientModal.style.display = 'none';
      document.body.style.overflow = 'auto';
      
      // Reset form
      patientForm.reset();
      clearFormErrors();
      
      // Reset age field
      document.getElementById('idadeAtual').value = '';
    }

    // Recording Modal Functions
    function openRecordingModal() {
      recordingModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }

    function closeRecordingModal() {
      recordingModal.style.display = 'none';
      if (!completedModal.style.display || completedModal.style.display === 'none') {
        document.body.style.overflow = 'auto';
      }
    }

    // Completed Modal Functions
    function openCompletedModal(duration, fileSize) {
      completedModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      // Update the modal with recording details
      document.getElementById('finalDuration').textContent = duration;
      document.getElementById('fileSize').textContent = fileSize;
    }

    function closeCompletedModal() {
      completedModal.style.display = 'none';
      document.body.style.overflow = 'auto';
      
      // Reset recording state
      isRecording = false;
      recordedChunks = [];
      patientData = null;
    }

    // Recording Functions
    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
          audio: {
            echoCancellation: true,
            noiseSuppression: true,
            autoGainControl: true,
            sampleRate: 44100
          } 
        });
        
        mediaRecorder = new MediaRecorder(stream, { 
          mimeType: 'audio/webm;codecs=opus' 
        });
        recordedChunks = [];
        
        mediaRecorder.ondataavailable = function(event) {
          if (event.data.size > 0) {
            recordedChunks.push(event.data);
          }
        };
        
        mediaRecorder.onstop = function() {
          // Stop all audio tracks
          stream.getTracks().forEach(track => track.stop());
          
          // Calculate final duration and file size
          const recordingEndTime = Date.now();
          const totalDuration = Math.floor((recordingEndTime - recordingStartTime) / 1000);
          const duration = formatDuration(totalDuration);
          
          const blob = new Blob(recordedChunks, { type: 'audio/webm' });
          const fileSizeMB = (blob.size / (1024 * 1024)).toFixed(1);
          const fileSize = `~${fileSizeMB} MB`;
          
          // Store the recording blob for sending
          window.recordingBlob = blob;
          
          // Clear timer
          if (recordingTimer) {
            clearInterval(recordingTimer);
            recordingTimer = null;
          }
          
          // Close recording modal and open completed modal
          closeRecordingModal();
          openCompletedModal(duration, fileSize);
        };
        
        mediaRecorder.start(1000); // Record in 1-second chunks
        isRecording = true;
        recordingStartTime = Date.now();
        
        // Start timer
        startRecordingTimer();
        
        // Open recording modal
        openRecordingModal();
        
      } catch (error) {
        console.error('Error starting recording:', error);
        addMessage('Erro ao iniciar gravação. Verifique as permissões do microfone.', 'ai');
      }
    }

    function stopRecording() {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        isRecording = false;
      }
    }

    function startRecordingTimer() {
      timerDisplay.textContent = '00:00';
      
      recordingTimer = setInterval(() => {
        const currentTime = Date.now();
        const elapsed = Math.floor((currentTime - recordingStartTime) / 1000);
        timerDisplay.textContent = formatTime(elapsed);
      }, 1000);
    }

    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }

    function formatDuration(seconds) {
      const hours = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      
      if (hours > 0) {
        return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      } else {
        return `00:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      }
    }

    // Send Recording Function
    async function sendRecording() {
      if (!window.recordingBlob || !patientData) {
        addMessage('Erro: Dados da gravação ou paciente não encontrados.', 'ai');
        return;
      }

      const sendBtn = document.querySelector('#completedModal .btn-primary');
      const originalText = sendBtn.innerHTML;
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<span>Enviando...</span>';

      try {
        const formData = new FormData();
        
        // Add audio file
        const audioFile = new File([window.recordingBlob], 'gravacao.webm', { 
          type: 'audio/webm' 
        });
        formData.append('file', audioFile);
        
        // Add patient data with correct field names for n8n webhook
        formData.append('nome_completo', patientData.nomeCompleto || '');
        formData.append('data_nascimento', patientData.dataNascimento || '');
        formData.append('idade', patientData.idadeAtual || '');
        formData.append('tipo_terapia', patientData.tipoTerapia || '');
        formData.append('serie_ano', patientData.serieEscolar || '');
        formData.append('responsavel', patientData.responsavelLegal || '');
        formData.append('email_responsavel', patientData.emailResponsavel || '');
        formData.append('telefone', patientData.telefoneResponsavel || '');
        formData.append('whatsapp', patientData.telefoneResponsavel || ''); // Using same as phone
        formData.append('observacoes', patientData.observacoes || '');
        
        // Send to n8n webhook
        const response = await fetch('https://atendimento1n8n-n8n.nid263.easypanel.host/webhook/audio-upload', {
          method: 'POST',
          body: formData
        });
        
        if (response.ok) {
          const result = await response.json();
          console.log('Upload successful:', result);
          
          addMessage(`Gravação enviada com sucesso! Paciente: ${patientData.nomeCompleto}`, 'ai');
          closeCompletedModal();
        } else {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
      } catch (error) {
        console.error('Error sending recording:', error);
        addMessage('Erro ao enviar gravação. Tente novamente.', 'ai');
      } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = originalText;
      }
    }

    // Form validation functions
    function validateEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    function validatePhone(phone) {
      const phoneRegex = /^[\d\s\(\)\-\+]+$/;
      return phoneRegex.test(phone) && phone.replace(/\D/g, '').length >= 10;
    }

    function calculateAge(birthDate) {
      const today = new Date();
      const birth = new Date(birthDate);
      let age = today.getFullYear() - birth.getFullYear();
      const monthDiff = today.getMonth() - birth.getMonth();
      
      if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
      
      return age;
    }

    function showFieldError(fieldId, message) {
      const errorElement = document.getElementById(fieldId + 'Error');
      if (errorElement) {
        errorElement.textContent = message;
      }
      
      const fieldElement = document.getElementById(fieldId);
      if (fieldElement) {
        fieldElement.style.borderColor = '#ef4444';
      }
    }

    function clearFieldError(fieldId) {
      const errorElement = document.getElementById(fieldId + 'Error');
      if (errorElement) {
        errorElement.textContent = '';
      }
      
      const fieldElement = document.getElementById(fieldId);
      if (fieldElement) {
        fieldElement.style.borderColor = 'rgba(255, 255, 255, 0.15)';
      }
    }

    function clearFormErrors() {
      const errorElements = document.querySelectorAll('.field-error');
      errorElements.forEach(element => {
        element.textContent = '';
      });
      
      const fieldElements = document.querySelectorAll('.form-input, .form-select, .form-textarea');
      fieldElements.forEach(element => {
        element.style.borderColor = 'rgba(255, 255, 255, 0.15)';
      });
    }

    // Auto-calculate age when birth date changes
    document.getElementById('dataNascimento').addEventListener('change', function() {
      const birthDate = this.value;
      if (birthDate) {
        const age = calculateAge(birthDate);
        document.getElementById('idadeAtual').value = age;
        clearFieldError('dataNascimento');
      }
    });

    // Real-time validation
    document.getElementById('nomeCompleto').addEventListener('blur', function() {
      if (this.value.trim().length < 2) {
        showFieldError('nomeCompleto', 'Nome deve ter pelo menos 2 caracteres');
      } else {
        clearFieldError('nomeCompleto');
      }
    });

    document.getElementById('emailResponsavel').addEventListener('blur', function() {
      if (this.value && !validateEmail(this.value)) {
        showFieldError('emailResponsavel', 'Por favor, insira um e-mail válido');
      } else {
        clearFieldError('emailResponsavel');
      }
    });

    document.getElementById('telefoneResponsavel').addEventListener('blur', function() {
      if (this.value && !validatePhone(this.value)) {
        showFieldError('telefoneResponsavel', 'Por favor, insira um telefone válido');
      } else {
        clearFieldError('telefoneResponsavel');
      }
    });

    // Form submission with recording workflow
    patientForm.addEventListener('submit', function(e) {
      e.preventDefault();
      
      // Clear previous errors
      clearFormErrors();
      
      let isValid = true;
      const formData = new FormData(this);
      const data = Object.fromEntries(formData);
      
      // Validate required fields
      if (!data.nomeCompleto.trim()) {
        showFieldError('nomeCompleto', 'Nome completo é obrigatório');
        isValid = false;
      } else if (data.nomeCompleto.trim().length < 2) {
        showFieldError('nomeCompleto', 'Nome deve ter pelo menos 2 caracteres');
        isValid = false;
      }
      
      if (!data.dataNascimento) {
        showFieldError('dataNascimento', 'Data de nascimento é obrigatória');
        isValid = false;
      }
      
      if (!data.tipoTerapia) {
        showFieldError('tipoTerapia', 'Tipo de terapia é obrigatório');
        isValid = false;
      }
      
      if (!data.serieEscolar) {
        showFieldError('serieEscolar', 'Série escolar é obrigatória');
        isValid = false;
      }
      
      if (!data.responsavelLegal.trim()) {
        showFieldError('responsavelLegal', 'Responsável legal é obrigatório');
        isValid = false;
      }
      
      if (!data.emailResponsavel.trim()) {
        showFieldError('emailResponsavel', 'E-mail do responsável é obrigatório');
        isValid = false;
      } else if (!validateEmail(data.emailResponsavel)) {
        showFieldError('emailResponsavel', 'Por favor, insira um e-mail válido');
        isValid = false;
      }
      
      if (!data.telefoneResponsavel.trim()) {
        showFieldError('telefoneResponsavel', 'Telefone do responsável é obrigatório');
        isValid = false;
      } else if (!validatePhone(data.telefoneResponsavel)) {
        showFieldError('telefoneResponsavel', 'Por favor, insira um telefone válido');
        isValid = false;
      }
      
      if (isValid) {
        // Add calculated age to data
        data.idadeAtual = document.getElementById('idadeAtual').value;
        
        // Store patient data for later use
        patientData = data;
        
        // Show success message in chat
        addMessage(`Paciente "${data.nomeCompleto}" cadastrado com sucesso! Iniciando gravação...`, 'ai');
        
        // Close patient modal
        closePatientModal();
        
        // Start recording workflow
        setTimeout(() => {
          startRecording();
        }, 500);
      }
    });

    // Close modals when clicking outside
    patientModal.addEventListener('click', function(e) {
      if (e.target === patientModal) {
        closePatientModal();
      }
    });

    recordingModal.addEventListener('click', function(e) {
      if (e.target === recordingModal) {
        // Don't close recording modal by clicking outside during recording
        // User must explicitly stop recording
      }
    });

    completedModal.addEventListener('click', function(e) {
      if (e.target === completedModal) {
        closeCompletedModal();
      }
    });

    // Close modals with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        if (patientModal.style.display === 'flex') {
          closePatientModal();
        } else if (completedModal.style.display === 'flex') {
          closeCompletedModal();
        }
        // Don't close recording modal with Escape during recording
      }
    });
    
    // Function to show help
    function showHelp() {
      addMessage('Como posso ajudar você? Use os botões abaixo para diferentes tipos de consulta:\n\n🔍 Pesquisar - Para buscar informações\n⚖️ Legal - Para questões jurídicas\n📋 BIRP - Para relatórios BIRP\n📝 SOAP - Para notas SOAP\n🎤 Cadastrar e gravar - Para cadastrar paciente e iniciar gravação', 'ai');
    }
    
    // Function to show typing indicator
    function showTyping() {
      typingIndicator.style.display = 'block';
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Function to hide typing indicator
    function hideTyping() {
      typingIndicator.style.display = 'none';
    }
    
    // Control buttons
    document.querySelectorAll('.control-btn').forEach(button => {
      button.addEventListener('click', function() {
        if (!this.onclick) { // Only for buttons without specific onclick handlers
          const label = this.getAttribute('aria-label');
          console.log('Control action:', label);
          // Add specific functionality for file chooser and attach
        }
      });
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.key === 'i') {
        e.preventDefault();
        chatInput.focus();
      }
    });
    
    // Focus on input when page loads
    chatInput.focus();
    
    // Close sidebar when clicking outside in mobile
    document.addEventListener('click', function(e) {
      if (window.innerWidth <= 639 && 
          !sidebar.contains(e.target) && 
          !e.target.classList.contains('collapse-btn') &&
          sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
      }
    });
    
    // Dynamic particle animation
    function createParticle() {
      const particle = document.createElement('div');
      particle.className = 'particle';
      particle.style.left = Math.random() * 100 + '%';
      particle.style.top = Math.random() * 100 + '%';
      particle.style.animationDelay = Math.random() * 6 + 's';
      document.querySelector('.background-container').appendChild(particle);
      
      setTimeout(() => {
        particle.remove();
      }, 6000);
    }
    
    // Create new particles periodically
    setInterval(createParticle, 3000);
  </script>
</body>
</html>